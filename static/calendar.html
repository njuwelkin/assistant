<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日历视图</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .calendar-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        h1 {
            font-size: 28px;
            font-weight: 600;
            color: #333;
        }
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .month-year {
            font-size: 20px;
            font-weight: 500;
            min-width: 150px;
            text-align: center;
        }
        .nav-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4);
        }
        .today-btn {
            padding: 8px 16px;
            background: rgba(118, 75, 162, 0.1);
            color: #764ba2;
            border: 1px solid rgba(118, 75, 162, 0.3);
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .today-btn:hover {
            background: rgba(118, 75, 162, 0.2);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 30px;
        }
        .weekday-header {
            text-align: center;
            font-weight: 600;
            color: #666;
            padding: 15px;
            border-radius: 10px;
            background: rgba(0,0,0,0.05);
        }
        .day-cell {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .day-cell:hover {
            background: rgba(118, 75, 162, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .day-cell.today {
            background: rgba(118, 75, 162, 0.2);
            border: 2px solid #764ba2;
        }
        .day-cell.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .day-cell.other-month {
            opacity: 0.3;
        }
        .day-number {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .day-indicators {
            display: flex;
            flex-direction: column;
            gap: 2px;
            width: 100%;
        }
        .indicator {
            height: 6px;
            border-radius: 3px;
            opacity: 0.8;
        }
        .indicator.school {
            background: #48bb78;
        }
        .indicator.homework {
            background: #f59e0b;
        }
        .indicator.activity {
            background: #3182ce;
        }
        .data-display {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }
        .selected-date {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }
        .data-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 8px 20px;
            background: rgba(0,0,0,0.05);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .tab-content {
            display: none;
            background: rgba(0,0,0,0.02);
            border-radius: 15px;
            padding: 20px;
        }
        .tab-content.active {
            display: block;
        }
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }
        .card-content {
            color: #666;
            line-height: 1.6;
        }
        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(229, 62, 62, 0.4);
        }
        
        /* 用户头像样式 */
        .user-avatar {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }
        
        /* 用户名样式 */
        .username-display {
            position: fixed;
            top: 90px;
            left: 20px;
            background: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            white-space: nowrap;
        }
        /* 响应式设计 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .calendar-container {
                padding: 20px;
            }
            .day-cell {
                padding: 5px;
            }
            .day-number {
                font-size: 14px;
            }
            .indicator {
                height: 4px;
            }
            .data-tabs {
                flex-direction: column;
            }
            .tab-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <img id="userAvatar" class="user-avatar" src="" alt="用户头像" style="display: none;">
    <div id="usernameDisplay" class="username-display" style="display: none;"></div>
    <button class="logout-btn" id="logoutButton">退出登录</button>
    
    <div class="calendar-container">
        <div class="header">
            <h1 style="margin-left: 80px;">我的日历</h1>
            <div class="calendar-nav">
                <button class="nav-btn" id="prevMonth">上个月</button>
                <div class="month-year" id="currentMonthYear"></div>
                <button class="nav-btn" id="nextMonth">下个月</button>
                <button class="today-btn" id="goToToday">今天</button>
            </div>
        </div>
        
        <div class="calendar-grid">
            <div class="weekday-header">周日</div>
            <div class="weekday-header">周一</div>
            <div class="weekday-header">周二</div>
            <div class="weekday-header">周三</div>
            <div class="weekday-header">周四</div>
            <div class="weekday-header">周五</div>
            <div class="weekday-header">周六</div>
            <!-- 日历单元格将由JavaScript动态生成 -->
        </div>
        
        <div class="data-display">
            <div class="selected-date" id="selectedDateDisplay">请选择一个日期</div>
            
            <div class="data-tabs">
                <button class="tab-btn active" data-tab="school">课程表</button>
                <button class="tab-btn" data-tab="homework">作业</button>
                <button class="tab-btn" data-tab="activity">活动</button>
            </div>
            
            <div class="tab-content active" id="school-content">
                <!-- 课程表内容将由JavaScript动态生成 -->
                <div id="school-data" class="loading">加载中...</div>
            </div>
            
            <div class="tab-content" id="homework-content">
                <!-- 作业内容将由JavaScript动态生成 -->
                <div id="homework-data" class="loading">加载中...</div>
            </div>
            
            <div class="tab-content" id="activity-content">
                <!-- 活动内容将由JavaScript动态生成 -->
                <div id="activity-data" class="loading">加载中...</div>
            </div>
        </div>
    </div>
    
    <script>
        // 检查是否有token
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
        }
        
        // 登出功能
        document.getElementById('logoutButton').addEventListener('click', function() {
            localStorage.removeItem('token');
            window.location.href = '/login';
        });
        
        // 日历功能
        let currentDate = new Date();
        let selectedDate = null;
        
        // 内存缓存 - 用于存储当月所有数据
        let monthlySchoolData = null;
        let monthlyAssignmentData = null;
        let monthlyActivityData = null;
        let cachedAvatarData = null;
        
        // 初始化日历
        function initCalendar() {
            generateCalendarCells();
            updateMonthYearDisplay();
            
            // 一次性加载当月所有数据
            loadAllData();
        }
        
        // 一次性加载当月所有数据
        async function loadAllData() {
            try {
                // 并行加载所有数据
                const [schoolData, assignmentData, activityData, avatarData] = await Promise.all([
                    loadMonthlySchoolData(),
                    loadMonthlyAssignmentData(),
                    loadMonthlyActivityData(),
                    loadAvatarDataFromServer()
                ]);
                
                // 存储数据到内存缓存
                monthlySchoolData = schoolData;
                monthlyAssignmentData = assignmentData;
                monthlyActivityData = activityData;
                cachedAvatarData = avatarData;
                
                // 显示用户头像
                displayUserAvatar(avatarData);
                
                // 选择今天并显示数据
                selectToday();
            } catch (error) {
                console.error('加载数据失败:', error);
                // 如果加载失败，尝试选择今天并加载单个日期的数据
                selectToday();
            }
        }
        
        // 在页面左上方显示用户头像
        function displayUserAvatar(avatarData) {
            const userAvatarElement = document.getElementById('userAvatar');
            const usernameDisplayElement = document.getElementById('usernameDisplay');
            
            if (avatarData.type === 'limited') {
                // 没有权限的情况
                usernameDisplayElement.textContent = `当前用户: ${avatarData.username}`;
                usernameDisplayElement.style.display = 'block';
                userAvatarElement.style.display = 'none';
            } else if (avatarData.type === 'full') {
                const { username, avatarUrl } = avatarData;
                
                // 显示用户名
                usernameDisplayElement.textContent = username;
                usernameDisplayElement.style.display = 'block';
                
                // 显示头像
                if (avatarUrl) {
                    userAvatarElement.src = avatarUrl;
                    userAvatarElement.style.display = 'block';
                } else {
                    // 如果没有头像，使用默认头像样式
                    userAvatarElement.src = '';
                    userAvatarElement.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    userAvatarElement.style.display = 'block';
                }
            }
        }
        
        // 加载当月所有课程表数据
        async function loadMonthlySchoolData() {
            try {
                const response = await fetch('/api/school_timetable', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('获取课程表失败');
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('加载课程表数据失败:', error);
                throw error;
            }
        }
        
        // 加载当月所有作业数据
        async function loadMonthlyAssignmentData() {
            try {
                const response = await fetch('/api/assignments', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('获取作业失败');
                }
                
                const data = await response.json();
                
                // 筛选出当月的作业
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                const monthStr = month < 10 ? `0${month}` : `${month}`;
                
                return data.filter(assignment => {
                    const assignmentDate = new Date(assignment.dueDate);
                    return assignmentDate.getFullYear() === year && 
                           (assignmentDate.getMonth() + 1) === month;
                });
            } catch (error) {
                console.error('加载作业数据失败:', error);
                throw error;
            }
        }
        
        // 加载当月所有活动数据
        async function loadMonthlyActivityData() {
            try {
                // 计算当月的开始和结束日期
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                
                // 当月第一天
                const startDate = new Date(year, month, 1);
                // 当月最后一天
                const endDate = new Date(year, month + 1, 0);
                
                // 格式化日期为YYYY-MM-DD格式
                const formatDate = (date) => {
                    const y = date.getFullYear();
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const d = String(date.getDate()).padStart(2, '0');
                    return `${y}-${m}-${d}`;
                };
                
                // 使用日期范围API获取整月活动数据
                const response = await fetch(`/api/activities?start_date=${formatDate(startDate)}&end_date=${formatDate(endDate)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('获取活动数据失败');
                }
                
                // 获取整月活动数据
                const activities = await response.json();
                
                // 确保每个活动都有date字段，方便后续筛选
                activities.forEach(activity => {
                    if (!activity.date) {
                        // 如果活动没有date字段，使用其date属性（可能已经存在）
                        activity.date = activity.date || formatDate(new Date());
                    }
                });
                
                return activities;
            } catch (error) {
                console.error('加载活动数据失败:', error);
                throw error;
            }
        }
        
        // 从服务器加载头像数据
        async function loadAvatarDataFromServer() {
            try {
                // 首先获取当前用户信息
                const userResponse = await fetch('/api/users/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!userResponse.ok) {
                    throw new Error('获取用户信息失败');
                }
                
                const userData = await userResponse.json();
                
                // 获取用户ID
                const username = userData.username;
                
                // 获取所有用户信息（需要管理员权限）
                const allUsersResponse = await fetch('/api/user', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!allUsersResponse.ok) {
                    // 如果没有权限，只返回当前用户名
                    return {
                        type: 'limited',
                        username: username
                    };
                }
                
                const allUsersData = await allUsersResponse.json();
                
                // 查找当前用户的ID
                const currentUser = allUsersData.find(user => user.username === username);
                
                if (currentUser) {
                    const userId = currentUser.id;
                    
                    // 尝试获取头像
                    try {
                        // 创建一个随机参数以避免缓存
                        const timestamp = new Date().getTime();
                        const avatarUrl = `/api/${userId}/avatar?${timestamp}`;
                        
                        // 检查头像是否存在
                        const avatarResponse = await fetch(avatarUrl, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (avatarResponse.ok) {
                            // 头像存在，返回头像信息
                            return {
                                type: 'full',
                                username: username,
                                userId: userId,
                                avatarUrl: avatarUrl
                            };
                        } else {
                            // 头像不存在，返回基本信息
                            return {
                                type: 'full',
                                username: username,
                                userId: userId,
                                avatarUrl: null
                            };
                        }
                    } catch (avatarError) {
                        // 返回基本信息
                        return {
                            type: 'full',
                            username: username,
                            userId: userId,
                            avatarUrl: null
                        };
                    }
                } else {
                    throw new Error('获取用户信息失败');
                }
            } catch (error) {
                console.error('加载头像数据失败:', error);
                throw error;
            }
        }
        
        // 生成日历单元格
        function generateCalendarCells() {
            const calendarGrid = document.querySelector('.calendar-grid');
            
            // 清空除了星期标题外的所有单元格
            const weekdayHeaders = document.querySelectorAll('.weekday-header');
            calendarGrid.innerHTML = '';
            
            // 重新添加星期标题
            weekdayHeaders.forEach(header => {
                calendarGrid.appendChild(header.cloneNode(true));
            });
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // 获取当月第一天是星期几（0-6，0是周日）
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            
            // 获取当月的天数
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // 获取上个月的天数
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            // 计算需要显示的单元格总数（包括上个月和下个月的部分日期）
            const totalCells = firstDayOfMonth + daysInMonth;
            const cellsToAdd = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            const totalDaysToDisplay = firstDayOfMonth + daysInMonth + cellsToAdd;
            
            // 生成上个月的部分日期
            for (let i = 0; i < firstDayOfMonth; i++) {
                const day = daysInPrevMonth - firstDayOfMonth + i + 1;
                const date = new Date(year, month - 1, day);
                const dayCell = createDayCell(date, day, true);
                calendarGrid.appendChild(dayCell);
            }
            
            // 生成当月的日期
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayCell = createDayCell(date, day, false);
                
                // 标记今天
                const today = new Date();
                if (date.getDate() === today.getDate() && 
                    date.getMonth() === today.getMonth() && 
                    date.getFullYear() === today.getFullYear()) {
                    dayCell.classList.add('today');
                }
                
                // 标记选中的日期
                if (selectedDate && 
                    date.getDate() === selectedDate.getDate() && 
                    date.getMonth() === selectedDate.getMonth() && 
                    date.getFullYear() === selectedDate.getFullYear()) {
                    dayCell.classList.add('selected');
                }
                
                calendarGrid.appendChild(dayCell);
            }
            
            // 生成下个月的部分日期
            for (let day = 1; day <= cellsToAdd; day++) {
                const date = new Date(year, month + 1, day);
                const dayCell = createDayCell(date, day, true);
                calendarGrid.appendChild(dayCell);
            }
        }
        
        // 创建日期单元格
        function createDayCell(date, day, isOtherMonth) {
            const dayCell = document.createElement('div');
            dayCell.classList.add('day-cell');
            
            if (isOtherMonth) {
                dayCell.classList.add('other-month');
            }
            
            const dayNumber = document.createElement('div');
            dayNumber.classList.add('day-number');
            dayNumber.textContent = day;
            
            const dayIndicators = document.createElement('div');
            dayIndicators.classList.add('day-indicators');
            
            dayCell.appendChild(dayNumber);
            dayCell.appendChild(dayIndicators);
            
            // 修复：使用自定义格式存储日期，避免时区问题
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // 月份从0开始
            const dateDay = String(date.getDate()).padStart(2, '0');
            dayCell.dataset.date = `${year}-${month}-${dateDay}`;
            
            // 添加点击事件
            dayCell.addEventListener('click', function() {
                // 移除之前选中的日期的样式
                const prevSelected = document.querySelector('.day-cell.selected');
                if (prevSelected) {
                    prevSelected.classList.remove('selected');
                }
                
                // 添加选中样式
                this.classList.add('selected');
                
                // 修复：直接使用传入的date对象，避免重新解析ISO字符串
                selectedDate = date;
                
                // 更新选中日期的显示
                updateSelectedDateDisplay();
                
                // 加载选中日期的数据
                loadDateData(selectedDate);
            });
            
            return dayCell;
        }
        
        // 更新月份年份显示
        function updateMonthYearDisplay() {
            const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', 
                               '七月', '八月', '九月', '十月', '十一月', '十二月'];
            const year = currentDate.getFullYear();
            const month = monthNames[currentDate.getMonth()];
            document.getElementById('currentMonthYear').textContent = `${year}年 ${month}`;
        }
        
        // 选择今天
        function selectToday() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const todayCell = document.querySelector(`.day-cell[data-date="${todayStr}"]`);
            
            if (todayCell) {
                todayCell.click();
            }
        }
        
        // 更新选中日期的显示
        function updateSelectedDateDisplay() {
            if (selectedDate) {
                const year = selectedDate.getFullYear();
                const month = selectedDate.getMonth() + 1;
                const day = selectedDate.getDate();
                const weekdayNames = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
                const weekday = weekdayNames[selectedDate.getDay()];
                document.getElementById('selectedDateDisplay').textContent = 
                    `${year}年${month}月${day}日 ${weekday}`;
            }
        }
        
        // 加载选中日期的数据 - 从内存缓存中获取
        function loadDateData(date) {
            // 修复：使用与createDayCell相同的格式创建日期字符串
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // 月份从0开始
            const day = String(date.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            
            // 加载课程表数据
            loadSchoolDataFromCache(date);
            
            // 加载作业数据
            loadHomeworkDataFromCache(dateStr);
            
            // 加载活动数据
            loadActivityDataFromCache(dateStr);
            
            // 加载头像数据
            loadAvatarDataFromCache();
        }
        
        // 从内存缓存中加载课程表数据
        function loadSchoolDataFromCache(date) {
            const schoolDataElement = document.getElementById('school-data');
            
            // 如果缓存中没有数据，显示加载中
            if (!monthlySchoolData) {
                schoolDataElement.innerHTML = '加载中...';
                return;
            }
            
            try {
                // 获取星期几（1-5表示周一到周五）
                const dayOfWeek = date.getDay();
                
                // 只有周一到周五才有课程
                if (dayOfWeek < 1 || dayOfWeek > 5) {
                    schoolDataElement.innerHTML = '当天没有课程安排';
                    return;
                }
                
                // 从缓存中筛选出对应星期几的课程
                const filteredData = monthlySchoolData.filter(course => course.day_of_week === dayOfWeek);
                
                if (filteredData.length === 0) {
                    schoolDataElement.innerHTML = '当天没有课程安排';
                } else {
                    // 按时间排序
                    filteredData.sort((a, b) => a.start_time.localeCompare(b.start_time));
                    
                    let html = '';
                    filteredData.forEach(course => {
                        html += `
                        <div class="card">
                            <div class="card-title">${course.course_name} (${course.start_time} - ${course.end_time})</div>
                            <div class="card-content">
                                <p><strong>教师:</strong> ${course.teacher_name}</p>
                                <p><strong>教室:</strong> ${course.classroom}</p>
                                <p><strong>周次:</strong> ${course.week_range}</p>
                            </div>
                        </div>
                        `;
                    });
                    
                    schoolDataElement.innerHTML = html;
                }
            } catch (error) {
                schoolDataElement.innerHTML = `获取课程表失败: ${error.message}`;
            }
        }
        
        // 原有的加载课程表数据函数，保持兼容性
        async function loadSchoolData(date) {
            loadSchoolDataFromCache(date);
        }
        
        // 从内存缓存中加载作业数据
        function loadHomeworkDataFromCache(dateStr) {
            const homeworkDataElement = document.getElementById('homework-data');
            
            // 如果缓存中没有数据，显示加载中
            if (!monthlyAssignmentData) {
                homeworkDataElement.innerHTML = '加载中...';
                return;
            }
            
            try {
                // 从缓存中筛选出指定日期的作业
                const filteredData = monthlyAssignmentData.filter(assignment => {
                    return assignment.dueDate === dateStr;
                });
                
                if (filteredData.length === 0) {
                    homeworkDataElement.innerHTML = '当天没有作业';
                } else {
                    // 按课程名称排序
                    filteredData.sort((a, b) => a.courseName.localeCompare(b.courseName));
                    
                    let html = '';
                    filteredData.forEach(assignment => {
                        html += `
                        <div class="card">
                            <div class="card-title">${assignment.courseName}: ${assignment.title}</div>
                            <div class="card-content">
                                <p><strong>截止日期:</strong> ${assignment.dueDate}</p>
                                <p><strong>描述:</strong> ${assignment.description}</p>
                                <p><strong>状态:</strong> ${assignment.isCompleted ? '已完成' : '未完成'}</p>
                            </div>
                        </div>
                        `;
                    });
                    
                    homeworkDataElement.innerHTML = html;
                }
            } catch (error) {
                homeworkDataElement.innerHTML = `获取作业失败: ${error.message}`;
            }
        }
        
        // 原有的加载作业数据函数，保持兼容性
        async function loadHomeworkData(dateStr) {
            loadHomeworkDataFromCache(dateStr);
        }
        
        // 从内存缓存中加载活动数据
        function loadActivityDataFromCache(dateStr) {
            const activityDataElement = document.getElementById('activity-data');
            
            // 如果缓存中没有数据，显示加载中
            if (!monthlyActivityData) {
                activityDataElement.innerHTML = '加载中...';
                return;
            }
            
            try {
                // 从缓存中筛选出指定日期的活动
                const filteredData = monthlyActivityData.filter(activity => {
                    return activity.date === dateStr;
                });
                
                if (filteredData.length === 0) {
                    activityDataElement.innerHTML = '当天没有活动';
                } else {
                    // 按时间排序
                    filteredData.sort((a, b) => a.time.localeCompare(b.time));
                    
                    let html = '';
                    filteredData.forEach(activity => {
                        html += `
                        <div class="card">
                            <div class="card-title">${activity.title} (${activity.time})</div>
                            <div class="card-content">
                                <p><strong>描述:</strong> ${activity.description}</p>
                                <p><strong>地点:</strong> ${activity.location}</p>
                                <p><strong>状态:</strong> ${activity.isAttended ? '已参加' : '未参加'}</p>
                            </div>
                        </div>
                        `;
                    });
                    
                    activityDataElement.innerHTML = html;
                }
            } catch (error) {
                activityDataElement.innerHTML = `获取活动失败: ${error.message}`;
            }
        }
        
        // 原有的加载活动数据函数，保持兼容性
        async function loadActivityData(dateStr) {
            loadActivityDataFromCache(dateStr);
        }
        
        // 从内存缓存中加载头像数据
        function loadAvatarDataFromCache() {
            const avatarDataElement = document.getElementById('avatar-data');
            
            // 如果缓存中没有数据，显示加载中
            if (!cachedAvatarData) {
                avatarDataElement.innerHTML = '加载中...';
                return;
            }
            
            try {
                if (cachedAvatarData.type === 'limited') {
                    // 没有权限的情况
                    avatarDataElement.innerHTML = `
                        <div class="card" style="text-align: center; padding: 40px;">
                            <h3>当前用户: ${cachedAvatarData.username}</h3>
                            <p>您没有权限查看头像信息</p>
                        </div>
                    `;
                } else if (cachedAvatarData.type === 'full') {
                    const { username, userId, avatarUrl } = cachedAvatarData;
                    
                    if (avatarUrl) {
                        // 头像存在，显示头像
                        avatarDataElement.innerHTML = `
                            <div class="card" style="text-align: center; padding: 40px;">
                                <h3>当前用户: ${username} (ID: ${userId})</h3>
                                <div style="margin: 20px 0;">
                                    <img src="${avatarUrl}" alt="用户头像" style="max-width: 200px; max-height: 200px; border-radius: 50%;">
                                </div>
                            </div>
                        `;
                    } else {
                        // 头像不存在，显示默认信息
                        avatarDataElement.innerHTML = `
                            <div class="card" style="text-align: center; padding: 40px;">
                                <h3>当前用户: ${username} (ID: ${userId})</h3>
                                <p>用户尚未上传头像</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                avatarDataElement.innerHTML = `加载头像数据失败: ${error.message}`;
            }
        }
        
        // 原有的加载头像数据函数，保持兼容性
        async function loadAvatarData() {
            loadAvatarDataFromCache();
        }
        
        // 标签页切换功能
        function setupTabNavigation() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 移除所有标签按钮的active类
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // 添加当前标签按钮的active类
                    this.classList.add('active');
                    
                    // 获取标签ID
                    const tabId = this.dataset.tab;
                    
                    // 隐藏所有标签内容
                    const tabContents = document.querySelectorAll('.tab-content');
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // 显示当前标签内容
                    document.getElementById(`${tabId}-content`).classList.add('active');
                });
            });
        }
        
        // 导航按钮事件监听
        function setupNavigationButtons() {
            // 上个月按钮
            document.getElementById('prevMonth').addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() - 1);
                generateCalendarCells();
                updateMonthYearDisplay();
                
                // 清除缓存并重新加载数据
                clearCache();
                loadAllData();
            });
            
            // 下个月按钮
            document.getElementById('nextMonth').addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() + 1);
                generateCalendarCells();
                updateMonthYearDisplay();
                
                // 清除缓存并重新加载数据
                clearCache();
                loadAllData();
            });
            
            // 今天按钮
            document.getElementById('goToToday').addEventListener('click', function() {
                const newToday = new Date();
                
                // 如果当前月份和今天的月份不同，需要重新加载数据
                if (currentDate.getMonth() !== newToday.getMonth() || 
                    currentDate.getFullYear() !== newToday.getFullYear()) {
                    currentDate = newToday;
                    generateCalendarCells();
                    updateMonthYearDisplay();
                    
                    // 清除缓存并重新加载数据
                    clearCache();
                    loadAllData();
                } else {
                    // 同一个月，只需要选择今天
                    currentDate = newToday;
                    selectToday();
                }
            });
        }
        
        // 清除内存缓存
        function clearCache() {
            monthlySchoolData = null;
            monthlyAssignmentData = null;
            monthlyActivityData = null;
            // 头像数据不需要清除，因为它不会随月份变化
        }
        
        // 初始化
        window.addEventListener('DOMContentLoaded', function() {
            initCalendar();
            setupTabNavigation();
            setupNavigationButtons();
        });
    </script>
</body>
</html>